---
title: "複数リポジトリのマイクロサービス構成で DevRag を使う方法"
date: "2024-12-28"
description: "60個以上のリポジトリを持つマイクロサービス構成で、Claude Code の DevRag をどう使えばいいか調べてみた。コンテキスト肥大化を防ぎつつ、全ドキュメントを横断検索できる構成をまとめる。"
tags: ["Claude Code", "DevRag", "RAG", "マイクロサービス", "AI"]
---

# 複数リポジトリのマイクロサービス構成で DevRag を使う方法

Claude Code に RAG を導入できる DevRag を使ってみたいが、マイクロサービス構成で多数のリポジトリを扱う場合はどうすればいいのか調べてみた。

## 想定する環境

- GitHub の 1 つの Organization 配下に 60 個程度のリポジトリがある
- 各リポジトリが独立したマイクロサービスを構成
- ローカルでは複数リポジトリを横断して作業することがある

## 困ること

### 困りごと 1: リポジトリごとに設定すると管理が大変

60 リポジトリそれぞれに `.mcp.json` と `config.json` を配置すると：

- 設定ファイルのメンテナンスが煩雑
- 横断的なドキュメント検索ができない
- 共通ドキュメントの更新が面倒

### 困りごと 2: 親ディレクトリで Claude Code を動かすとコンテキストが肥大化

```
~/work/
└── repos/
    ├── api-gateway/
    ├── auth-service/
    ├── user-service/
    └── ... (60リポジトリ)
```

この構成で親ディレクトリから Claude Code を起動すると、60 リポジトリ分のファイルツリーがコンテキストに入り、性能が低下する。

## 解決策: 中央集約 + 作業セット方式

調べた結果、ドキュメントは中央に集約しつつ、Claude Code のコンテキストは作業中のリポジトリに限定する構成が有効。

### ディレクトリ構成

```
~/work/
├── .claudeignore              ← repos/ を除外してコンテキスト肥大化を防止
├── CLAUDE.md                  ← プロジェクト全体の説明
├── active/                    ← 今作業中のリポジトリだけシンボリックリンク
│   ├── api-gateway -> ../repos/api-gateway
│   └── web-app -> ../repos/web-app
├── repos/                     ← 全リポジトリ（.claudeignore で除外）
│   ├── api-gateway/
│   ├── auth-service/
│   ├── user-service/
│   └── ... (60リポジトリ)
├── docs/                      ← DevRag 用ドキュメント集約
│   ├── _shared/               ← 共通ドキュメント
│   │   ├── coding-standards.md
│   │   └── architecture.md
│   ├── api-gateway/           ← 各リポジトリの docs へのシンボリックリンク
│   ├── auth-service/
│   └── ...
├── config.json                ← DevRag 設定
└── .mcp.json                  ← MCP 設定
```

### セットアップ手順

#### 1. ディレクトリ構造を作成

```bash
cd ~/work
mkdir -p active docs/_shared repos
```

#### 2. 全リポジトリをクローン

```bash
cd ~/work/repos

# GitHub CLI を使う場合
gh repo list YOUR_ORG --limit 100 --json name -q '.[].name' | \
  xargs -I {} gh repo clone YOUR_ORG/{}

# または既存のクローン済みリポジトリを移動
```

#### 3. ドキュメント同期スクリプトを作成

全リポジトリの docs をシンボリックリンクで集約するスクリプト。

```bash
#!/bin/bash
# ~/work/scripts/sync-docs.sh

REPOS_DIR=~/work/repos
DOCS_DIR=~/work/docs

echo "Syncing documentation from repositories..."

for repo in "$REPOS_DIR"/*/; do
    repo_name=$(basename "$repo")

    # docs/ または documents/ があればリンク作成
    if [ -d "$repo/docs" ]; then
        ln -sfn "$repo/docs" "$DOCS_DIR/$repo_name"
        echo "  Linked: $repo_name/docs"
    elif [ -d "$repo/documents" ]; then
        ln -sfn "$repo/documents" "$DOCS_DIR/$repo_name"
        echo "  Linked: $repo_name/documents"
    elif [ -f "$repo/README.md" ]; then
        # docs がなければ README だけでもリンク
        mkdir -p "$DOCS_DIR/$repo_name"
        ln -sfn "$repo/README.md" "$DOCS_DIR/$repo_name/README.md"
        echo "  Linked: $repo_name/README.md"
    fi
done

echo "Done. Synced $(ls -1 $DOCS_DIR | wc -l) repositories"
```

```bash
chmod +x ~/work/scripts/sync-docs.sh
~/work/scripts/sync-docs.sh
```

#### 4. .claudeignore を作成

`.claudeignore` を使うと、Claude Code のコンテキストから特定のディレクトリを除外できる。

```gitignore
# ~/work/.claudeignore

# 全リポジトリを除外（active/ 経由でアクセス）
repos/

# ビルド成果物
**/node_modules/
**/dist/
**/build/
**/.next/
**/target/
**/__pycache__/
**/venv/

# DevRag のデータベース
vectors.db
```

#### 5. DevRag の設定

```json
// ~/work/config.json
{
  "documents_dir": "./docs",
  "db_path": "./vectors.db",
  "chunk_size": 500,
  "search_top_k": 10
}
```

#### 6. MCP の設定

```json
// ~/work/.mcp.json
{
  "mcpServers": {
    "devrag": {
      "type": "stdio",
      "command": "/usr/local/bin/devrag"
    }
  }
}
```

#### 7. CLAUDE.md を作成

CLAUDE.md にプロジェクト構成を書いておくと、Claude Code がコンテキストとして認識する。

```markdown
# ~/work/CLAUDE.md

## プロジェクト概要

このディレクトリはマイクロサービス構成のプロジェクト。
60 以上のリポジトリで構成。

## ディレクトリ構成

- `active/` - 現在作業中のリポジトリ（シンボリックリンク）
- `repos/` - 全リポジトリ（通常は参照しない）
- `docs/` - 全リポジトリのドキュメント集約（DevRag 用）

## 作業の進め方

1. `active/` 配下のリポジトリを対象に作業してください
2. 他のリポジトリの情報が必要な場合は DevRag で検索してください
3. `repos/` を直接参照する必要がある場合は、明示的に指示してください

## 主要サービス

- api-gateway: API ゲートウェイ、認証・ルーティング
- auth-service: 認証・認可サービス
- user-service: ユーザー管理
- ...
```

### 作業セットの切り替え

作業対象のリポジトリを変更するスクリプト。

```bash
#!/bin/bash
# ~/work/scripts/activate.sh
# 使い方: ./scripts/activate.sh api-gateway auth-service web-app

ACTIVE_DIR=~/work/active
REPOS_DIR=~/work/repos

# 既存のリンクをクリア
rm -f "$ACTIVE_DIR"/*

# 指定されたリポジトリをリンク
for repo in "$@"; do
    if [ -d "$REPOS_DIR/$repo" ]; then
        ln -s "$REPOS_DIR/$repo" "$ACTIVE_DIR/$repo"
        echo "Activated: $repo"
    else
        echo "Warning: $repo not found in repos/"
    fi
done

echo ""
echo "Active repositories:"
ls -la "$ACTIVE_DIR"
```

```bash
# 使用例
~/work/scripts/activate.sh api-gateway auth-service web-app
```

## 運用のポイント

### ドキュメントの定期同期

Git pull 後にドキュメントを同期する。

```bash
# 全リポジトリを更新してドキュメントを同期
cd ~/work/repos
for repo in */; do
    (cd "$repo" && git pull --ff-only)
done
~/work/scripts/sync-docs.sh
```

cron や Git hooks で自動化しても良さそう。

### インデックスの再構築

ドキュメントが大きく変わった場合は、`vectors.db` を削除して再起動すると再構築される。

```bash
rm ~/work/vectors.db
# Claude Code を再起動すると自動でインデックス再構築
```

### 検索精度の調整

60 リポジトリ分のドキュメントがあると、検索結果が分散しがち。設定で調整できる。

```json
// config.json
{
  "search_top_k": 10, // デフォルト 5 から増やす
  "chunk_size": 300 // より細かく分割して精度向上
}
```

実際に使いながら調整していくのが良さそう。

### ドキュメントの名前空間

ディレクトリ構造で整理すると、検索時に絞り込みやすくなる。

```
docs/
├── _shared/              ← 共通（先頭 _ で優先表示）
├── backend/
│   ├── api-gateway/
│   ├── auth-service/
│   └── user-service/
├── frontend/
│   ├── web-app/
│   └── admin-app/
└── infrastructure/
    ├── terraform/
    └── k8s-manifests/
```

「backend の認証フローについて教えて」のように質問すると、パスに `backend` を含むドキュメントが優先されやすくなりそう。

## まとめ

| 困りごと                | 解決策                                  |
| ----------------------- | --------------------------------------- |
| 60 リポジトリの設定管理 | 中央集約（`docs/`）+ 1 つの DevRag 設定 |
| コンテキスト肥大化      | `.claudeignore` で `repos/` を除外      |
| 作業対象の切り替え      | `active/` にシンボリックリンク          |
| 横断検索                | DevRag で全ドキュメントを検索可能       |

ポイント：

1. **ドキュメントは集約、コードは分離** - DevRag は全ドキュメントを見れるが、Claude Code のコンテキストは作業中のリポジトリだけ
2. **シンボリックリンクの活用** - 実体をコピーせず、参照だけを管理
3. **`.claudeignore` の活用** - 不要なファイルをコンテキストから除外

この構成で、大規模なマイクロサービスプロジェクトでも DevRag を活用できる。実際に運用してみて、検索精度やコンテキストの最適化は調整していく予定。

---

## 付録: 前提知識

### DevRag とは

DevRag は Claude Code 用の無料 RAG ツール。ドキュメントをベクトル検索できるようになり、Claude Code が自動で関連情報を見つけてくれる。

詳しくは：[Claude Code に無料の RAG 導入でトークン＆時間節約](https://zenn.dev/abalol/articles/claude-code-rag)

リポジトリ：https://github.com/tomohiro-owada/devrag

### MCP のスコープ

Claude Code の MCP 設定には 3 つのスコープがある。

| スコープ  | 設定ファイル                             | 影響範囲                             |
| --------- | ---------------------------------------- | ------------------------------------ |
| `local`   | `~/.claude.json`（プロジェクトパス配下） | そのプロジェクトのみ（個人用）       |
| `project` | `.mcp.json`（プロジェクトルート）        | そのプロジェクトのみ（チーム共有可） |
| `user`    | `~/.claude.json`                         | 全プロジェクト共通                   |

優先順位は `local` > `project` > `user` の順。

### DevRag の設定オプション

`config.json` で設定できる主なオプション：

```json
{
  "documents_dir": "./documents", // ドキュメントのディレクトリ
  "db_path": "./vectors.db", // ベクトルDBのパス
  "chunk_size": 500, // チャンクサイズ（文字数）
  "search_top_k": 5, // 検索結果の返却件数
  "compute": {
    "device": "auto", // 計算デバイス（auto/cpu/gpu）
    "fallback_to_cpu": true
  },
  "model": {
    "name": "multilingual-e5-small",
    "dimensions": 384
  }
}
```
